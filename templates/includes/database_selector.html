{% load cache %}
<!-- Selector de bases de datos optimizado -->
<div class="database-selector-wrapper bg-dark">
    <div class="d-flex justify-content-center align-items-center">
        <form class="d-flex ml-auto" action="{% url form_url %}" method="post" id="FormSelectorBase">
            {% csrf_token %}
            <div class="form-group w-100">
                <select class="form-control" id="database_select" name="database_select">
                    <option disabled>Seleccione una empresa</option>
                    {% for database_name,database_nmEmpresa in databases_list %}
                    <option value="{{ database_name }}" {% if database_name == database_name_session %}selected{% endif %}>{{ database_nmEmpresa }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

{% cache 1800 "database_selector_js" %}
<!-- JavaScript optimizado para el selector -->
<script>
    $(document).ready(function () {
        // Cache DOM elements para mejor rendimiento
        var $databaseSelect = $('#database_select');
        var $form = $('#FormSelectorBase');
        var formUrl = "{% url form_url %}";
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        // Establecer la opci칩n seleccionada del servidor
        var currentDatabase = "{{ database_name_session|default:'' }}";
        if (currentDatabase) {
            $databaseSelect.val(currentDatabase);
        }

        // Manejar cambio de base de datos con debounce
        var changeTimeout;
        $databaseSelect.on('change', function () {
            clearTimeout(changeTimeout);
            var selectedDatabase = $(this).val();
            
            if (selectedDatabase) {
                changeTimeout = setTimeout(function() {
                    updateDatabaseName(selectedDatabase);
                }, 300); // Debounce de 300ms
            }
        });
    });

    function updateDatabaseName(newDatabase) {
        console.log("Actualizando base de datos:", newDatabase);
        
        var $databaseSelect = $('#database_select');
        
        // Mostrar indicador de carga optimizado
        $databaseSelect.prop('disabled', true).addClass('loading');
        
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        $.ajax({
            url: "{% url form_url %}",
            type: "POST",
            data: {
                'database_select': newDatabase,
                'csrfmiddlewaretoken': csrfToken
            },
            cache: false,
            timeout: 10000, // 10 segundos timeout
            success: function(response) {
                console.log("Base de datos actualizada:", newDatabase);
                // Recargar la p치gina para reflejar los cambios
                window.location.reload();
            },
            error: function(xhr, status, error) {
                console.error("Error al actualizar base de datos:", error, status);
                var message = "Error al cambiar la base de datos.";
                
                if (status === 'timeout') {
                    message += " La operaci칩n tard칩 demasiado tiempo.";
                } else if (xhr.status === 403) {
                    message += " No tiene permisos para esta base de datos.";
                } else if (xhr.status === 500) {
                    message += " Error interno del servidor.";
                }
                
                alert(message + " Intente nuevamente.");
            },
            complete: function() {
                $databaseSelect.prop('disabled', false).removeClass('loading');
            }
        });
    }
</script>
{% endcache %}