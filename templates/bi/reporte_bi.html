<!-- 
  reporte_bi.html - Template para vista temporal de Power BI con URLs públicas
  
  CONTEXTO REQUERIDO:
  - url_powerbi: URL pública del reporte de Power BI para la empresa seleccionada
  - selected_database: Objeto con información de la empresa (name, nmEmpresa, id)
  - form_url: URL para el selector de base de datos (compatible con database_selector.html)
  
  FUNCIONALIDAD:
  - Carga reportes de Power BI usando URLs públicas (sin tokens de autenticación)
  - Solución temporal mientras se resuelven problemas de tokens vencidos
  - Compatible con el selector de empresas existente
-->
{% extends 'black.html' %}
{% load static %}

{% block title %}
{% if selected_database.nmEmpresa %}BI - {{selected_database.nmEmpresa}}{% else %}BI Dashboard{% endif %}
{% endblock title %}

{% block barra_lateral %}
<div id="sidebar-container">
{% include 'includes/left_sidebar_bi.html' %}
</div>
{% endblock barra_lateral %}

{% block window %}
<!-- CSS personalizado para control de sidebar -->
<style>
    /* Transiciones suaves para el sidebar */
    #sidebar-container {
        transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1000;
        background: inherit;
    }
    
    /* Clase para ocultar sidebar */
    .sidebar-hidden #sidebar-container {
        transform: translateX(-100%);
    }
    
    /* Ajuste del contenido principal cuando sidebar está oculto */
    .sidebar-hidden .main-content {
        margin-left: 0 !important;
        width: 100% !important;
    }
    
    /* Barra de control flotante */
    .sidebar-toggle-bar {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        backdrop-filter: blur(5px);
    }
    
    .sidebar-toggle-bar:hover {
        background: rgba(40, 167, 69, 1);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    /* Cuando sidebar está oculto, mover el botón más a la izquierda */
    .sidebar-hidden .sidebar-toggle-bar {
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
    }
    
    .sidebar-hidden .sidebar-toggle-bar:hover {
        background: rgba(108, 117, 125, 1);
    }
    
    /* Ajustes para contenido principal */
    .main-content {
        transition: margin-left 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    /* Icono rotación */
    .toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .sidebar-hidden .toggle-icon {
        transform: rotate(180deg);
    }
</style>

<!-- Barra de control flotante -->
<button class="sidebar-toggle-bar" onclick="toggleSidebar()" title="Ocultar/Mostrar menú lateral (Ctrl + B)">
    <i class="fas fa-bars toggle-icon"></i>
    <span class="toggle-text">Ocultar menú</span>
</button>

<!-- 
  IMPORTANTE: Para que el selector de base de datos funcione correctamente en esta página, 
  la vista de Django que renderiza esta plantilla DEBE pasar la variable de contexto 'form_url'.
  Esta variable debe contener el nombre de la URL (ej: 'home_app:database_select') 
  de la vista que maneja la actualización de la base de datos en la sesión del servidor.
-->
<div class="container-fluid mt-4 main-content">
    {% if error_message %}
    <div class="alert alert-danger">
        <p>{{ error_message }}</p>
    </div>
    {% else %}
    
    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="alert alert-warning" role="alert">
      {% for message in messages %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Modal de carga (Bootstrap) -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <div>
              <strong>Preparando los datos para su visualización...</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor del reporte usando iframe para URL pública -->
    <div id="reportContainer" style="height: 85vh; width: 100%;">
        {% if url_powerbi %}
        <iframe 
            class="embed-responsive-item" 
            src="{{url_powerbi}}"
            title="{% if selected_database.nmEmpresa %}{{selected_database.nmEmpresa}} - Dashboard BI{% else %}Dashboard BI{% endif %}" 
            allowfullscreen="true" 
            id="powerbi-iframe"
            style="width: 100%; height: 100%; border: none;"
            onload="handleIframeLoad()"
            onerror="handleIframeError()">
        </iframe>
        {% else %}
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>URL de Power BI no configurada</h4>
            {% if selected_database.nmEmpresa %}
            <p>No se encontró una URL pública de Power BI configurada para <strong>{{selected_database.nmEmpresa}}</strong>.</p>
            {% else %}
            <p>No se encontró una URL pública de Power BI configurada para esta empresa.</p>
            {% endif %}
            <p>Contacte al administrador para configurar la URL en el sistema.</p>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS si no está cargado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        // Variables globales
        var loadingModal;
        var powerbiIframe = document.getElementById('powerbi-iframe');
        var sidebarHidden = false;

        // Función para toggle del sidebar
        function toggleSidebar() {
            var body = document.body;
            var toggleText = document.querySelector('.toggle-text');
            var toggleIcon = document.querySelector('.toggle-icon');
            
            if (sidebarHidden) {
                // Mostrar sidebar
                body.classList.remove('sidebar-hidden');
                toggleText.textContent = 'Ocultar menú';
                toggleIcon.className = 'fas fa-bars toggle-icon';
                sidebarHidden = false;
                console.log("Sidebar mostrado");
            } else {
                // Ocultar sidebar
                body.classList.add('sidebar-hidden');
                toggleText.textContent = 'Mostrar menú';
                toggleIcon.className = 'fas fa-arrow-right toggle-icon';
                sidebarHidden = true;
                console.log("Sidebar ocultado");
            }
            
            // Guardar preferencia en localStorage
            localStorage.setItem('powerbi-sidebar-hidden', sidebarHidden);
        }

        // Atajo de teclado para toggle sidebar (Ctrl + B)
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'b') {
                event.preventDefault();
                toggleSidebar();
            }
        });

        // Función auto-ejecutable para inicializar
        (function () {
            // Restaurar preferencia de sidebar del localStorage
            var savedState = localStorage.getItem('powerbi-sidebar-hidden');
            if (savedState === 'true') {
                toggleSidebar();
            }

            // Solo mostrar modal de carga si hay URL de Power BI
            {% if url_powerbi %}
            // Mostrar el modal de carga
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            {% endif %}

            // Obtener la base de datos seleccionada de sessionStorage para usarla en el reporte si es necesario
            var database = window.sessionStorage.getItem("database_name");
            console.log("Base de datos seleccionada (para reporte BI):", database);

            if (!database) {
                console.warn("No se ha seleccionado una base de datos para el reporte BI");
            }

            {% if not url_powerbi %}
            console.warn("No hay URL de Power BI configurada para esta empresa");
            {% endif %}
        })();

        // Función para manejar la carga exitosa del iframe
        function handleIframeLoad() {
            console.log("Reporte BI cargado correctamente");
            
            // Ocultar modal de carga
            setTimeout(function() {
                if (loadingModal) {
                    loadingModal.hide();
                }
            }, 1000);
        }

        // Función para manejar errores del iframe
        function handleIframeError() {
            console.error("Error al cargar el reporte BI");
            var reportContainer = document.getElementById('reportContainer');
            reportContainer.innerHTML = '<div class="alert alert-danger">Ocurrió un error al cargar el reporte. Por favor, verifique su conexión o contacte al administrador.</div>';
            if (loadingModal) {
                loadingModal.hide();
            }
        }

        // Función para actualizar la URL del Power BI si es necesaria (para uso futuro)
        function updatePowerBIUrl() {
            var currentUrl = "{{url_powerbi|default:''}}";
            if (currentUrl && currentUrl !== "None" && currentUrl !== "") {
                var iframe = document.getElementById('powerbi-iframe');
                if (iframe) {
                    iframe.src = currentUrl;
                    console.log("URL de Power BI actualizada:", currentUrl);
                }
            } else {
                console.error("URL de Power BI no disponible");
                handleIframeError();
            }
        }

        // Función original para compatibilidad con posibles llamadas AJAX
        function handleServerResponse(status, responseText) {
            if (status === 200) {
                try {
                    // Parsea la respuesta JSON
                    var jsonResponse = JSON.parse(responseText);
                    
                    // Obtiene la URL de la clave 'url_powerbi'
                    var powerbiUrl = jsonResponse.url_powerbi;
                    console.log("Nueva URL recibida:", powerbiUrl);
                    
                    if (powerbiUrl) {
                        // Mostrar modal de carga
                        if (loadingModal) {
                            loadingModal.show();
                        }
                        
                        // Establecer la URL directamente en el iframe
                        powerbiIframe.src = powerbiUrl;
                        console.log("URL establecida:", powerbiUrl);
                    }
                } catch (error) {
                    console.error("Error parseando respuesta JSON:", error);
                    handleIframeError();
                }
            } else {
                console.error("Error en la solicitud:", status, responseText);
                handleIframeError();
            }
        }
    </script>
    {% endif %}
</div>
{% endblock window %}

{# Eliminar cualquier bloque script personalizado que intente sincronizar la DB en esta página #}
{% block script %}
{# Dejar vacío o añadir scripts específicos de esta página que NO interfieran con database_selector.html #}
{% endblock script %}