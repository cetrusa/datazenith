<!-- 
  reporte_bi.html - Template para vista temporal de Power BI con URLs públicas
  
  CONTEXTO REQUERIDO:
  - url_powerbi: URL pública del reporte de Power BI para la empresa seleccionada
  - selected_database: Objeto con información de la empresa (name, nmEmpresa, id)
  - form_url: URL para el selector de base de datos (compatible con database_selector.html)
  
  FUNCIONALIDAD:
  - Carga reportes de Power BI usando URLs públicas (sin tokens de autenticación)
  - Solución temporal mientras se resuelven problemas de tokens vencidos
  - Compatible con el selector de empresas existente
-->
{% extends 'black.html' %}
{% load static %}

{% block title %}
{% if selected_database.nmEmpresa %}BI - {{selected_database.nmEmpresa}}{% else %}BI Dashboard{% endif %}
{% endblock title %}

{% block barra_lateral %}
<div id="sidebar-container">
{% include 'includes/left_sidebar_bi.html' %}
</div>
{% endblock barra_lateral %}

{% block window %}

<!-- Barra de control flotante -->
<button 
    id="sidebar-toggle-btn"
    class="sidebar-toggle-bar" 
    aria-label="Alternar menú lateral (Ctrl+B)"
    aria-expanded="false"
    aria-controls="sidebar-container"
    title="Ocultar/Mostrar menú lateral (Ctrl + B)">
    <i class="fas fa-bars toggle-icon"></i>
    <span class="toggle-text">Ocultar menú</span>
</button>

<!-- 
  IMPORTANTE: Para que el selector de base de datos funcione correctamente en esta página, 
  la vista de Django que renderiza esta plantilla DEBE pasar la variable de contexto 'form_url'.
  Esta variable debe contener el nombre de la URL (ej: 'home_app:database_select') 
  de la vista que maneja la actualización de la base de datos en la sesión del servidor.
-->
<div class="container-fluid mt-4 main-content">
    {% if error_message %}
    <div class="alert alert-danger">
        <p>{{ error_message }}</p>
    </div>
    {% else %}
    
    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="alert alert-warning" role="alert">
      {% for message in messages %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Modal de carga (Bootstrap) -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <div>
              <strong>Preparando los datos para su visualización...</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor del reporte usando iframe para URL pública -->
    <div id="reportContainer" style="height: 85vh; width: 100%;">
        {% if url_powerbi %}
        <iframe 
            class="embed-responsive-item" 
            src="{{url_powerbi}}"
            title="{% if selected_database.nmEmpresa %}{{selected_database.nmEmpresa}} - Dashboard BI{% else %}Dashboard BI{% endif %}" 
            allowfullscreen="true" 
            id="powerbi-iframe"
            style="width: 100%; height: 100%; border: none;"
            onload="handleIframeLoad()"
            onerror="handleIframeError()">
        </iframe>
        {% else %}
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>URL de Power BI no configurada</h4>
            {% if selected_database.nmEmpresa %}
            <p>No se encontró una URL pública de Power BI configurada para <strong>{{selected_database.nmEmpresa}}</strong>.</p>
            {% else %}
            <p>No se encontró una URL pública de Power BI configurada para esta empresa.</p>
            {% endif %}
            <p>Contacte al administrador para configurar la URL en el sistema.</p>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS si no está cargado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        // IIFE para evitar contaminación del scope global
        (function() {
            'use strict';
            
            // Constantes y configuración
            const CONFIG = {
                LOCALSTORAGE_KEY: 'powerbi-sidebar-hidden',
                LOADING_TIMEOUT: 15000, // 15 segundos
                DEBUG_MODE: true
            };
            
            // Logger simple y reutilizable
            const Logger = {
                debug: (msg) => { if (CONFIG.DEBUG_MODE) console.log('[PowerBI] ' + msg); },
                warn: (msg) => { console.warn('[PowerBI] ' + msg); },
                error: (msg) => { console.error('[PowerBI] ' + msg); }
            };
            
            // Estado de la aplicación
            let state = {
                loadingModal: null,
                powerbiIframe: null,
                sidebarHidden: false,
                loadingTimeout: null
            };
            
            /**
             * Función para alternar el sidebar
             * Con validación de elementos y manejo seguro de localStorage
             */
            function toggleSidebar() {
                const body = document.body;
                const toggleText = document.querySelector('.toggle-text');
                const toggleIcon = document.querySelector('.toggle-icon');
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                
                // Validar que los elementos existan
                if (!body || !toggleText || !toggleIcon || !toggleBtn) {
                    Logger.error('Elementos necesarios no encontrados para toggle sidebar');
                    return;
                }
                
                state.sidebarHidden = !state.sidebarHidden;
                
                if (state.sidebarHidden) {
                    body.classList.add('sidebar-hidden');
                    toggleText.textContent = 'Mostrar menú';
                    toggleIcon.className = 'fas fa-arrow-right toggle-icon';
                    toggleBtn.setAttribute('aria-expanded', 'false');
                    Logger.debug('Sidebar ocultado');
                } else {
                    body.classList.remove('sidebar-hidden');
                    toggleText.textContent = 'Ocultar menú';
                    toggleIcon.className = 'fas fa-bars toggle-icon';
                    toggleBtn.setAttribute('aria-expanded', 'true');
                    Logger.debug('Sidebar mostrado');
                }
                
                // Guardar preferencia en localStorage de forma segura
                try {
                    localStorage.setItem(CONFIG.LOCALSTORAGE_KEY, state.sidebarHidden);
                } catch (e) {
                    Logger.warn('localStorage no disponible: ' + e.message);
                }
            }
            
            /**
             * Restaurar estado del sidebar desde localStorage
             */
            function restoreSidebarState() {
                try {
                    const savedState = localStorage.getItem(CONFIG.LOCALSTORAGE_KEY);
                    if (savedState === 'true') {
                        state.sidebarHidden = true;
                        const body = document.body;
                        if (body) {
                            body.classList.add('sidebar-hidden');
                            const toggleText = document.querySelector('.toggle-text');
                            const toggleIcon = document.querySelector('.toggle-icon');
                            const toggleBtn = document.getElementById('sidebar-toggle-btn');
                            if (toggleText) toggleText.textContent = 'Mostrar menú';
                            if (toggleIcon) toggleIcon.className = 'fas fa-arrow-right toggle-icon';
                            if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
                        }
                        Logger.debug('Estado del sidebar restaurado desde localStorage');
                    }
                } catch (e) {
                    Logger.warn('No se pudo restaurar estado del sidebar: ' + e.message);
                }
            }
            
            /**
             * Manejar carga exitosa del iframe
             */
            function handleIframeLoad() {
                Logger.debug('Reporte BI cargado correctamente');
                clearTimeout(state.loadingTimeout);
                
                // Ocultar modal con pequeño delay
                setTimeout(() => {
                    if (state.loadingModal) {
                        try {
                            state.loadingModal.hide();
                        } catch (e) {
                            Logger.warn('Error al ocultar modal: ' + e.message);
                        }
                    }
                }, 500);
            }
            
            /**
             * Manejar errores del iframe
             */
            function handleIframeError() {
                Logger.error('Error al cargar el reporte BI');
                clearTimeout(state.loadingTimeout);
                
                const reportContainer = document.getElementById('reportContainer');
                if (reportContainer) {
                    reportContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Ocurrió un error al cargar el reporte. Por favor, verifique su conexión o contacte al administrador.</div>';
                }
                
                if (state.loadingModal) {
                    try {
                        state.loadingModal.hide();
                    } catch (e) {
                        Logger.warn('Error al ocultar modal en error: ' + e.message);
                    }
                }
            }
            
            /**
             * Configurar timeout de carga para modal
             */
            function setupLoadingTimeout() {
                state.loadingTimeout = setTimeout(() => {
                    Logger.warn('Tiempo de carga de Power BI excedido');
                    if (state.loadingModal) {
                        try {
                            state.loadingModal.hide();
                        } catch (e) {
                            Logger.warn('Error al ocultar modal en timeout: ' + e.message);
                        }
                    }
                }, CONFIG.LOADING_TIMEOUT);
            }
            
            /**
             * Inicialización de la aplicación
             */
            function init() {
                Logger.debug('Inicializando aplicación Power BI');
                
                // Validar existencia de iframe de Power BI
                state.powerbiIframe = document.getElementById('powerbi-iframe');
                if (!state.powerbiIframe) {
                    Logger.debug('Power BI iframe no encontrado (probablemente sin URL configurada)');
                } else {
                    Logger.debug('Power BI iframe encontrado');
                    setupLoadingTimeout();
                }
                
                // Restaurar estado del sidebar
                restoreSidebarState();
                
                // Mostrar modal de carga si hay URL de Power BI
                const loadingModalEl = document.getElementById('loadingModal');
                if (loadingModalEl && state.powerbiIframe) {
                    try {
                        state.loadingModal = new bootstrap.Modal(loadingModalEl);
                        state.loadingModal.show();
                    } catch (e) {
                        Logger.warn('Error al mostrar modal: ' + e.message);
                    }
                }
                
                // Obtener base de datos seleccionada
                const database = window.sessionStorage ? window.sessionStorage.getItem('database_name') : null;
                Logger.debug('Base de datos seleccionada: ' + (database || 'ninguna'));
            }
            
            /**
             * Configurar manejadores de eventos
             */
            function setupEventHandlers() {
                // Click en botón de toggle
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', toggleSidebar);
                    Logger.debug('Manejador de click para toggle button configurado');
                } else {
                    Logger.warn('Botón de toggle sidebar no encontrado');
                }
                
                // Atajo de teclado Ctrl + B
                document.addEventListener('keydown', (event) => {
                    if (event.ctrlKey && event.key === 'b') {
                        event.preventDefault();
                        toggleSidebar();
                    }
                });
                Logger.debug('Atajo de teclado Ctrl+B configurado');
            }
            
            /**
             * Punto de entrada - ejecutar cuando el DOM está listo
             */
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setupEventHandlers();
                    init();
                });
            } else {
                // El DOM ya está listo
                setupEventHandlers();
                init();
            }
            
        })(); // Fin de IIFE
    </script>
    {% endif %}
</div>
{% endblock window %}

{% block style %}
<!-- CSS personalizado para control de sidebar -->
<style>
    /* Transiciones suaves para el sidebar */
    #sidebar-container {
        transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1000;
        background: inherit;
    }
    
    /* Clase para ocultar sidebar */
    .sidebar-hidden #sidebar-container {
        transform: translateX(-100%);
    }
    
    /* Ajuste del contenido principal cuando sidebar está oculto */
    .sidebar-hidden .main-content {
        margin-left: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Contenido normal con sidebar visible */
    .main-content {
        transition: margin-left 0.3s ease-in-out, width 0.3s ease-in-out, max-width 0.3s ease-in-out;
    }
    
    /* Barra de control flotante */
    .sidebar-toggle-bar {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        backdrop-filter: blur(5px);
    }
    
    .sidebar-toggle-bar:hover {
        background: rgba(40, 167, 69, 1);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    /* Cuando sidebar está oculto, cambiar color del botón */
    .sidebar-hidden .sidebar-toggle-bar {
        background: rgba(108, 117, 125, 0.9);
    }
    
    .sidebar-hidden .sidebar-toggle-bar:hover {
        background: rgba(108, 117, 125, 1);
    }
    
    /* Icono rotación */
    .toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .sidebar-hidden .toggle-icon {
        transform: rotate(180deg);
    }
    
    /* Accesibilidad: Mostrar focus visible para teclado */
    .sidebar-toggle-bar:focus-visible {
        outline: 2px solid #0d6efd;
        outline-offset: 2px;
    }
    
    /* Contenedor del reporte - se expande con transición suave */
    #reportContainer {
        transition: width 0.3s ease-in-out;
    }
    
    .sidebar-hidden #reportContainer {
        width: 100% !important;
    }
</style>
{% endblock style %}

{# Eliminar cualquier bloque script personalizado que intente sincronizar la DB en esta página #}
{% block script %}
{# Dejar vacío o añadir scripts específicos de esta página que NO interfieran con database_selector.html #}
{% endblock script %}