{% extends 'black.html' %}
{% load static %}

{% block title %}
Interface Siigo
{% endblock title %}

{% block barra_lateral %}
{% include 'includes/left_sidebar_interface.html' %}
{% endblock barra_lateral %}

{% block window %}
{% include 'includes/datepicker_range.html' %}
<br>
<br>
<div class="container">
  {% if messages %}
  <div class="alert alert-warning" role="alert">
    {% for message in messages %}
    <p>{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <div class="card" style="width: 25rem;">
    <div class="card-header text-center">
      <h2>Interface Siigo</h2>
    </div>
    <div class="card-body">
      <form action="{% url form_url %}" method="post" id="FormInterfaceSiigo">
        {% csrf_token %}
        <label for="date_input">Fecha:</label>
        <div id="reportrange"
          style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
          <i class="fa fa-calendar"></i>&nbsp;
          <span></span> <i class="fa fa-caret-down"></i>
        </div>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th><label class="lh-1" for="IdtReporteIni">Fecha Inicial:</label></th>
              <th><label class="lh-1" for="IdtReporteFin">Fecha Final:</label></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th><input type="date" name="IdtReporteIni" id="IdtReporteIni" readonly></th>
              <th><input type="date" name="IdtReporteFin" id="IdtReporteFin" readonly></th>
            </tr>
          </tbody>
        </table>
        <div class="form-group mt-3">
          <label for="batch_size">Tamaño de lote (registros por procesamiento):</label>
          <select class="form-control" id="batch_size" name="batch_size">
            <option value="10000">10,000 (Equipos con pocos recursos)</option>
            <option value="20000">20,000</option>
            <option value="50000" selected>50,000 (Estándar)</option>
            <option value="100000">100,000</option>
            <option value="200000">200,000</option>
          </select>
          <small class="form-text text-muted">Ajusta según tamaño de datos y capacidad del servidor.</small>
        </div>
    </div>
    <span class="card text-center"><button id="submitBtnInterfaceSiigo" type="submit" class="btn btn-primary"
        data-submitted="false">Generar Interface Siigo</button></span>
    </form>

    <br>
    <br>
    {% include 'includes/download_file.html' %}
  </div>

  <div class="modal" id="processingModalSiigo" tabindex="-1" role="dialog" aria-labelledby="processingModalLabelSiigo"
    aria-hidden="true" style="display: none; background-color: rgba(0, 0, 0, 0.5);">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="processingModalLabelSiigo">Procesando Interface Siigo...</h5>
        </div>
        <div class="modal-body">
          <div id="progress-stage-siigo" class="mb-3 font-weight-bold">Por favor, espere mientras se genera el archivo...</div>
          <div class="progress" style="height: 20px;">
            <div id="progressBarSiigo" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
              role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div id="detailedStatusSiigo" class="small text-muted mt-3 p-2 border-top"></div>
          <p id="time-info-siigo" class="mt-2 small text-muted">Tiempo transcurrido: 0 seg</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock window %}

{% block script %}
<script>
  document.getElementById("processingModalSiigo").style.display = "none";
  document.getElementById("download_file").className = 'd-none';
  const csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
  let startTimeSiigo = 0;
  let progressIntervalSiigo = null;
  const progressBarSiigo = document.getElementById("progressBarSiigo");

  document.getElementById("submitBtnInterfaceSiigo").addEventListener("click", function (event) {
    event.preventDefault();
    if (this.getAttribute("data-submitted") === "true") {
      alert("Ya hay una tarea de Interface Siigo en curso.");
      return;
    }
    const database = window.sessionStorage.getItem("database_name");
    const IdtReporteIni = document.getElementById("IdtReporteIni").value;
    const IdtReporteFin = document.getElementById("IdtReporteFin").value;
    const batchSize = document.getElementById("batch_size").value;
    if (!database || !IdtReporteIni || !IdtReporteFin) {
      stopMonitoringSiigo("Seleccione empresa y ambas fechas.", true, 0);
      return;
    }
    this.setAttribute("data-submitted", "true");
    startTimeSiigo = new Date().getTime();
    updateProgressBarSiigo(0, "Iniciando generación...");
    document.getElementById("processingModalSiigo").style.display = "flex";
    if (progressIntervalSiigo) clearInterval(progressIntervalSiigo);
    progressIntervalSiigo = setInterval(updateElapsedTimeSiigo, 1000);

    const xhr = new XMLHttpRequest();
    xhr.responseType = "text";
    xhr.open("POST", "{% url form_url %}", true);
    xhr.setRequestHeader("X-CSRFToken", csrf_token);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function () {
      if (this.readyState === XMLHttpRequest.DONE) {
        try {
          const response = JSON.parse(this.responseText);
          handleServerResponseSiigo(this.status, response);
        } catch (e) {
          console.error("Error procesando respuesta inicio interface siigo:", e, this.responseText);
          stopMonitoringSiigo("Error al procesar la respuesta del servidor al iniciar la tarea.");
        }
      }
    };
    xhr.send("database_select=" + encodeURIComponent(database) +
      "&IdtReporteIni=" + encodeURIComponent(IdtReporteIni) +
      "&IdtReporteFin=" + encodeURIComponent(IdtReporteFin) +
      "&batch_size=" + encodeURIComponent(batchSize));
  });

  function handleServerResponseSiigo(status, response) {
    if (status === 200) {
      if (typeof response === "object" && "success" in response) {
        if (response.success) {
          window.sessionStorage.setItem("interface_siigo_task_id", response.task_id);
          updateProgressBarSiigo(5, "Tarea iniciada. Esperando procesamiento...");
          setTimeout(checkTaskStatusSiigo, 1000);
        } else {
          stopMonitoringSiigo("Error al iniciar el proceso: " + (response.error_message || "Error desconocido"));
        }
      } else {
        stopMonitoringSiigo("La respuesta del servidor no es un objeto JSON válido al iniciar.");
      }
    } else {
      stopMonitoringSiigo("Error al enviar la solicitud, código de estado: " + status);
    }
  }

  function checkTaskStatusSiigo() {
    const task_id = window.sessionStorage.getItem("interface_siigo_task_id");
    if (!task_id) {
      stopMonitoringSiigo(null, false);
      return;
    }
    const timestamp = new Date().getTime();
    const xhr = new XMLHttpRequest();
    xhr.responseType = "text";
    xhr.open("POST", "{% url 'home_app:check_task_status' %}?t=" + timestamp, true);
    xhr.setRequestHeader("X-CSRFToken", csrf_token);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function () {
      if (this.readyState === XMLHttpRequest.DONE) {
        try {
          const response = JSON.parse(this.responseText);
          handleTaskStatusSiigo(this.status, response);
        } catch (e) {
          console.error("Error procesando respuesta check_task_status (siigo):", e, this.responseText);
          stopMonitoringSiigo("Error al procesar la respuesta del servidor sobre el estado de la tarea.");
        }
      }
    };
    xhr.send("task_id=" + encodeURIComponent(task_id));
  }

  function handleTaskStatusSiigo(status, response) {
    if (status === 200) {
      if (typeof response === "object" && "status" in response) {
        const detailedStatusEl = document.getElementById("detailedStatusSiigo");
        const progressValue = response.progress !== undefined ? response.progress : parseInt(progressBarSiigo.getAttribute("aria-valuenow")) || 5;
        const stageText = response.stage || (response.meta && response.meta.stage) || "Procesando...";
        updateProgressBarSiigo(progressValue, stageText);
        updateEtaInfoSiigo(response.eta);
        detailedStatusEl.innerText = "";
        if (response.meta) {
          let detailText = "";
          if (response.meta.current_step && response.meta.total_steps) {
            detailText += `Paso ${response.meta.current_step} de ${response.meta.total_steps}. `;
          }
          if (response.meta.records_processed !== undefined && response.meta.total_records_estimate !== undefined) {
            detailText += `${response.meta.records_processed.toLocaleString()} de ${response.meta.total_records_estimate.toLocaleString()} registros. `;
          } else if (response.meta.records_processed !== undefined) {
            detailText += `${response.meta.records_processed.toLocaleString()} registros procesados. `;
          }
          detailedStatusEl.innerText = detailText;
        }
        const taskStatus = response.status.toLowerCase();
        if (["completed", "finished", "success"].includes(taskStatus)) {
          updateProgressBarSiigo(100, "Proceso completado exitosamente");
          document.getElementById("download_file").className = 'd-flex';
          let message = "¡Proceso completado exitosamente!";
          if (response.result) {
            if (response.result.message) message = response.result.message;
            if (response.result.metadata && response.result.metadata.total_records !== undefined) {
              message += ` Se procesaron ${response.result.metadata.total_records.toLocaleString()} registros.`;
            }
            if (response.result.execution_time !== undefined) {
              message += ` Tiempo total: ${response.result.execution_time.toFixed(1)} seg.`;
            }
          }
          stopMonitoringSiigo(message, true, 1000);
        } else if (taskStatus === "failed") {
          updateProgressBarSiigo(100, "Proceso fallido");
          let errorMsg = "Error en el proceso";
          if (response.error) errorMsg = response.error;
          else if (response.result && typeof response.result === 'string') errorMsg = response.result;
          else if (response.result && response.result.error) errorMsg = response.result.error;
          else if (response.meta && response.meta.error) errorMsg = response.meta.error;
          else if (response.traceback) {
            errorMsg = response.traceback.split('\n').slice(-2)[0];
          }
          stopMonitoringSiigo("Hubo un error en el proceso: " + errorMsg, true, 1000);
        } else if (taskStatus === "partial_success") {
          updateProgressBarSiigo(100, "Completado con advertencias");
          document.getElementById("download_file").className = 'd-flex';
          let partialMsg = "El archivo se generó, pero hubo algunas advertencias.";
          if (response.result && response.result.message) partialMsg = response.result.message;
          stopMonitoringSiigo(partialMsg, true, 1000);
        } else {
          if (response.meta && response.meta.file_ready && progressValue >= 80) {
            document.getElementById("download_file").className = 'd-flex';
          }
          setTimeout(checkTaskStatusSiigo, 1000);
        }
      } else {
        stopMonitoringSiigo("Respuesta inválida del servidor.");
      }
    } else {
      stopMonitoringSiigo("Error de comunicación con el servidor. Código: " + status);
    }
  }

  function updateProgressBarSiigo(value, text) {
    progressBarSiigo.style.width = value + "%";
    progressBarSiigo.setAttribute("aria-valuenow", value);
    progressBarSiigo.textContent = value + "%";
    document.getElementById("progress-stage-siigo").innerText = text || "Procesando...";
  }

  function updateElapsedTimeSiigo() {
    const now = new Date().getTime();
    const elapsedSeconds = Math.floor((now - startTimeSiigo) / 1000);
    document.getElementById("time-info-siigo").innerText = "Tiempo transcurrido: " + elapsedSeconds + " seg";
  }

  function updateEtaInfoSiigo(eta) {
    if (!eta) return;
    document.getElementById("time-info-siigo").innerText += ` | ETA: ${eta.toFixed(1)} seg`;
  }

  function stopMonitoringSiigo(message, showAlert = true, delay = 0) {
    if (progressIntervalSiigo) clearInterval(progressIntervalSiigo);
    setTimeout(() => {
      document.getElementById("processingModalSiigo").style.display = "none";
      document.getElementById("submitBtnInterfaceSiigo").setAttribute("data-submitted", "false");
      if (showAlert && message) alert(message);
    }, delay);
  }
</script>
{% endblock script %}
