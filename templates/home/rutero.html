{% extends 'black.html' %}
{% load static %}

{% block title %}Informe Rutero{% endblock title %}
{% block barra_lateral %}
{% include 'includes/left_sidebar_bimbo.html' %}
{% endblock barra_lateral %}
{% block window %}

<div class="container my-4">
  {% if messages %}
  <div class="alert alert-warning" role="alert">
    {% for message in messages %}
    <p class="mb-0">{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h2 class="h5 mb-0">Informe Rutero</h2>
        <small class="text-muted">Maestro de Rutas y Clientes</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="button" id="btnSubmit" data-submitted="false">Generar reporte</button>
      </div>
    </div>
    <div class="card-body">
      <form action="{% url form_url %}" method="post" id="FormRutero" onsubmit="event.preventDefault(); return false;">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold" for="ceves_code_select">CEVE (obligatorio)</label>
            <select class="form-select" name="ceves_code" id="ceves_code_select" {% if not ceves_catalog %}disabled{% endif %} required>
              {% if ceves_catalog %}
              <option value="">Seleccione CEVES</option>
              {% for ceve in ceves_catalog %}
              <option value="{{ ceve.id }}">{{ ceve.label }}</option>
              {% endfor %}
              {% else %}
              <option value="" selected>Sin CEVES disponibles</option>
              {% endif %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Tamaño de lote</label>
            <select class="form-select" id="batch_size" name="batch_size">
              <option value="10000">10,000</option>
              <option value="20000">20,000</option>
              <option value="50000" selected>50,000</option>
              <option value="100000">100,000</option>
            </select>
            <small class="text-muted">Ajuste si el dataset es grande</small>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Progress Area -->
  <div id="processingModal" style="display:none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div class="bg-white p-4 rounded shadow text-center" style="max-width: 400px; width: 90%;">
        <h5 id="progress-stage" class="mb-3 text-dark">Iniciando...</h5>
        <div class="progress mb-3">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <div id="detailedStatus" class="small text-muted mb-3"></div>
        <div id="time-info" class="small text-muted mb-3">Tiempo transcurrido: 0 seg</div>
        <button id="btnCancel" onclick="resetUI()" class="btn btn-sm btn-danger d-none">Cancelar (UI)</button>
    </div>
  </div>

  <div id="download_file" class="d-none alert alert-success">
     Reporte generado exitosamente. <a href="#" id="downloadLink" class="alert-link">Descargar aquí</a>
  </div>

</div>
{% endblock window %}

{% block script %}
<script>
  const csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
  const progressBar = document.getElementById("progressBar");
  const progressStage = document.getElementById("progress-stage");
  const ceveSelect = document.getElementById("ceves_code_select");
  let progressInterval = null;
  let startTime = 0;

  function updateProgressBar(value, stageText) {
    const safeValue = Math.max(0, Math.min(100, Number(value) || 0));
    progressBar.style.width = safeValue + "%";
    progressBar.setAttribute("aria-valuenow", safeValue);
    progressBar.textContent = safeValue.toFixed(0) + "%";
    if (stageText) progressStage.textContent = stageText;
  }

  function updateElapsedTime() {
    if (startTime > 0) {
      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById("time-info").textContent = "Tiempo transcurrido: " + elapsedSeconds + " seg";
    }
  }

  function resetUI() {
    document.getElementById("processingModal").style.display = "none";
    document.getElementById("btnSubmit").setAttribute("data-submitted", "false");
    clearInterval(progressInterval);
  }

  function checkTaskStatus(jobId) {
    const formData = new FormData();
    formData.append("task_id", jobId);

    fetch("{% url 'home_app:check_task_status' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrfToken
      }
    })
      .then(r => r.json())
      .then(data => {
        if (data.state === "COMPLETED" || data.status === "completed" || data.status === "finished") {
          updateProgressBar(100, "Completado");
          setTimeout(() => {
             resetUI();
             const result = data.result;
             if(result && result.success) {
                const link = document.getElementById("downloadLink");
                link.href = "{% url 'home_app:download_file' %}?path=" + encodeURIComponent(result.file_name);
                document.getElementById("download_file").className = "alert alert-success";
             } else {
                alert("Error: " + (result.error_message || "Desconocido"));
             }
          }, 1000);
        } else if (data.state === "FAILED" || data.status === "failed") {
          resetUI();
          alert("La tarea falló.");
        } else {
           // Processing
           const meta = data.meta || {};
           updateProgressBar(meta.progress || 10, meta.stage || "Procesando...");
           setTimeout(() => checkTaskStatus(jobId), 2000);
        }
      })
      .catch(e => {
         console.error(e);
         setTimeout(() => checkTaskStatus(jobId), 5000);
      });
  }

  document.getElementById("btnSubmit").addEventListener("click", function (event) {
    event.preventDefault();
    if (this.getAttribute("data-submitted") === "true") return;
    
    const ceve = ceveSelect.value;
    const batchSize = document.getElementById("batch_size").value;
    if (!ceve) { alert("Seleccione CEVE"); return; }

    this.setAttribute("data-submitted", "true");
    startTime = Date.now();
    updateProgressBar(0, "Iniciando...");
    document.getElementById("processingModal").style.display = "flex";
    document.getElementById("download_file").className = "d-none";
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(updateElapsedTime, 1000);

    const xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("POST", "{% url form_url %}", true);
    xhr.setRequestHeader("X-CSRFToken", csrfToken);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function () {
      if (this.readyState === XMLHttpRequest.DONE) {
        if (this.status === 200 && this.response && this.response.success) {
           checkTaskStatus(this.response.job_id);
        } else {
           resetUI();
           alert("Error al iniciar la tarea: " + (this.response && this.response.error_message ? this.response.error_message : "Error desconocido"));
        }
      }
    };
    const body = "ceves_code=" + encodeURIComponent(ceve) + "&batch_size=" + encodeURIComponent(batchSize);
    xhr.send(body);
  });
</script>
{% endblock script %}