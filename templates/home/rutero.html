{% extends 'black.html' %}
{% load static %}

{% block title %}Informe Rutero{% endblock title %}
{% block barra_lateral %}
{% include 'includes/left_sidebar_bimbo.html' %}
{% endblock barra_lateral %}
{% block window %}

<div class="container my-4">
  {% if messages %}
  <div class="alert alert-warning" role="alert">
    {% for message in messages %}
    <p class="mb-0">{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

    <div class="card shadow-lg mb-4" style="width: 100%; max-width: 700px; margin: auto;">
        <div class="card-header bg-white text-dark border-bottom-0 pt-4">
            <h2 class="mb-0 text-center fw-bold" style="color: #E21F26;">Informe Maestro Rutero</h2>
            <p class="text-muted text-center">Gesti칩n de Rutas y Clientes por Agencia</p>
        </div>
        <div class="card-body">
            <form action="{% url form_url %}" method="post" id="FormRutero" onsubmit="event.preventDefault(); return false;">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group mb-3">
                            <label class="form-label fw-bold" for="ceves_code_select">Agencia (CEVE):</label>
                            <select class="form-select border-0 shadow-sm" name="ceves_code" id="ceves_code_select" style="background-color: #f8f9fa;" {% if not ceves_catalog %}disabled{% endif %} required>
                                {% if ceves_catalog %}
                                <option value="">-- Seleccione una Agencia --</option>
                                {% for ceve in ceves_catalog %}
                                <option value="{{ ceve.id }}">{{ ceve.label }}</option>
                                {% endfor %}
                                {% else %}
                                <option value="" selected>Sin Agencias disponibles</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Tama침o de Lote:</label>
                            <select class="form-select border-0 shadow-sm" id="batch_size" name="batch_size" style="background-color: #f8f9fa;">
                                <option value="10000">10,000</option>
                                <option value="20000">20,000</option>
                                <option value="50000" selected>50,000</option>
                                <option value="100000">100,000</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button id="btnSubmit" type="button" class="btn btn-danger px-5 shadow-sm" style="background-color: #E21F26; border: none;">
                        <i class="fas fa-file-excel me-2"></i> Generar Reporte Rutero
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress Area -->
    <div id="processingModal" style="display:none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
        <div class="bg-dark text-white p-4 rounded-3 shadow-lg text-center" style="max-width: 450px; width: 90%;">
            <h5 id="progress-stage" class="mb-3"><i class="fas fa-route fa-spin me-2 text-danger"></i>Iniciando...</h5>
            <div class="progress mb-3" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="detailedStatus" class="small text-muted mb-3 border-top border-secondary pt-2"></div>
            <div id="time-info" class="small text-muted mb-3 text-end">Tiempo: 0s</div>
            <button id="btnCancel" onclick="resetUI()" class="btn btn-sm btn-outline-danger d-none">Cancelar Operaci칩n</button>
        </div>
    </div>

    <div id="download_file" class="d-none mt-4">
        {% include 'includes/download_file.html' %}
    </div>

</div>
{% endblock window %}

{% block script %}
<script>
  const csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
  const progressBar = document.getElementById("progressBar");
  const progressStage = document.getElementById("progress-stage");
  const ceveSelect = document.getElementById("ceves_code_select");
  let progressInterval = null;
  let startTime = 0;

  function updateProgressBar(value, stageText) {
    const safeValue = Math.max(0, Math.min(100, Number(value) || 0));
    progressBar.style.width = safeValue + "%";
    progressBar.setAttribute("aria-valuenow", safeValue);
    progressBar.textContent = safeValue.toFixed(0) + "%";
    if (stageText) progressStage.textContent = stageText;
  }

  function updateElapsedTime() {
    if (startTime > 0) {
      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsedSeconds / 60);
      const secs = elapsedSeconds % 60;
      document.getElementById("time-info").textContent = "Tiempo: " + (mins > 0 ? mins + "m " : "") + secs + "s";
    }
  }

  function resetUI() {
    document.getElementById("processingModal").style.display = "none";
    document.getElementById("btnSubmit").setAttribute("data-submitted", "false");
    clearInterval(progressInterval);
  }

  function checkTaskStatus(jobId) {
    const formData = new FormData();
    formData.append("task_id", jobId);

    fetch("{% url 'home_app:check_task_status' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrfToken
      }
    })
      .then(r => r.json())
      .then(data => {
        if (data.state === "COMPLETED" || data.status === "completed" || data.status === "finished") {
          updateProgressBar(100, "Completado");
          setTimeout(() => {
             resetUI();
             const result = data.result;
             if(result && result.success) {
                const link = document.getElementById("downloadLink");
                link.href = "{% url 'home_app:download_file' %}?path=" + encodeURIComponent(result.file_name);
                document.getElementById("download_file").className = "alert alert-success";
             } else {
                alert("Error: " + (result.error_message || "Desconocido"));
             }
          }, 1000);
        } else if (data.state === "FAILED" || data.status === "failed") {
          resetUI();
          alert("La tarea fall칩.");
        } else {
           // Processing
           const meta = data.meta || {};
           updateProgressBar(meta.progress || 10, meta.stage || "Procesando...");
           setTimeout(() => checkTaskStatus(jobId), 2000);
        }
      })
      .catch(e => {
         console.error(e);
         setTimeout(() => checkTaskStatus(jobId), 5000);
      });
  }

  document.getElementById("btnSubmit").addEventListener("click", function (event) {
    event.preventDefault();
    if (this.getAttribute("data-submitted") === "true") return;
    
    const ceve = ceveSelect.value;
    const batchSize = document.getElementById("batch_size").value;
    if (!ceve) { alert("Seleccione CEVE"); return; }

    this.setAttribute("data-submitted", "true");
    startTime = Date.now();
    updateProgressBar(0, "Iniciando...");
    document.getElementById("processingModal").style.display = "flex";
    document.getElementById("download_file").className = "d-none";
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(updateElapsedTime, 1000);

    const xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("POST", "{% url form_url %}", true);
    xhr.setRequestHeader("X-CSRFToken", csrfToken);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function () {
      if (this.readyState === XMLHttpRequest.DONE) {
        if (this.status === 200 && this.response && this.response.success) {
           checkTaskStatus(this.response.job_id);
        } else {
           resetUI();
           alert("Error al iniciar la tarea: " + (this.response && this.response.error_message ? this.response.error_message : "Error desconocido"));
        }
      }
    };
    const body = "ceves_code=" + encodeURIComponent(ceve) + "&batch_size=" + encodeURIComponent(batchSize);
    xhr.send(body);
  });
</script>
{% endblock script %}